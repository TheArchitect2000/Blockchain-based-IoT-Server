name: Deploy to Staging

on:
  push:
    branches: [staging]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_PRIVATE_KEY }}" > ~/.ssh/staging_key
          chmod 600 ~/.ssh/staging_key
          ssh-keyscan -H ${{ secrets.STAGING_SERVER }} >> ~/.ssh/known_hosts

      - name: Deploy to staging server
        env:
          HOSTNAME: ${{ secrets.STAGING_SERVER }}
          USERNAME: ${{ secrets.STAGING_USER }}
        run: |
          ssh -i ~/.ssh/staging_key ${USERNAME}@${HOSTNAME} << 'EOF'
            set -e
            
            PROJECT_DIR="/home/fidesinnova-stg"
            PROJECT_NAME="staging"
            
            echo "üì¶ Pulling latest changes..."
            cd $PROJECT_DIR
            
            # Clean any Docker-created files that might block git
            sudo find . -type f -name "*.js" -exec chown ${USERNAME}:${USERNAME} {} \;
            sudo find . -type d -exec chmod 755 {} \;
            sudo find . -type f -exec chmod 644 {} \;
            
            # Force clean git state
            git clean -fd
            git fetch origin staging
            git reset --hard origin/staging
            
            # Restore permissions
            sudo chown -R ${USERNAME}:${USERNAME} $PROJECT_DIR
            
            echo "üîß Stopping existing containers..."
            # Stop staging containers
            docker compose -p $PROJECT_NAME down --remove-orphans
            
            # Stop development containers if they exist
            docker compose -p dev down --remove-orphans 2>/dev/null || true
            
            echo "üîç Freeing up ports..."
            # Kill any process still using the ports (backup safety measure)
            sudo lsof -ti:${WEBAPP_PORT:-4000} | xargs -r sudo kill -9 || true
            sudo lsof -ti:${BACK_PORT:-3001} | xargs -r sudo kill -9 || true
            sudo lsof -ti:${ADMIN_WEBAPP_PORT:-4001} | xargs -r sudo kill -9 || true
            
            echo "üèóÔ∏è Building Docker images..."
            docker compose -p $PROJECT_NAME build --no-cache
            
            echo "üöÄ Starting containers..."
            docker compose -p $PROJECT_NAME up -d
            
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 10
            
            echo "üìä Container status:"
            docker compose -p $PROJECT_NAME ps
            
            echo "üßπ Cleaning up unused Docker resources..."
            docker image prune -af --filter "until=24h"
            docker volume prune -f --filter "label!=keep"
            
            echo "‚úÖ Deployment completed successfully!"
          EOF

      - name: Verify deployment
        env:
          HOSTNAME: ${{ secrets.STAGING_SERVER }}
          USERNAME: ${{ secrets.STAGING_USER }}
        run: |
          ssh -i ~/.ssh/staging_key ${USERNAME}@${HOSTNAME} << 'EOF'
            PROJECT_NAME="staging"
            
            # Check if all containers are running
            RUNNING=$(docker compose -p $PROJECT_NAME ps --status running --quiet | wc -l)
            TOTAL=$(docker compose -p $PROJECT_NAME ps --quiet | wc -l)
            
            echo "Containers running: $RUNNING/$TOTAL"
            
            if [ "$RUNNING" -ne "$TOTAL" ]; then
              echo "‚ùå Not all containers are running!"
              docker compose -p $PROJECT_NAME logs --tail=50
              exit 1
            fi
            
            echo "‚úÖ All containers are running"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/staging_key

      - name: Send notification on failure
        if: failure()
        run: |
          echo "Deployment failed! Check the logs above for details."
          # Add your notification service here (Slack, Discord, email, etc.)
