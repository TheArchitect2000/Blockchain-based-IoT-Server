name: Deploy to Main
permissions:
  contents: read

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup SSH connection via AWS SSM
        run: |
          # Install AWS CLI and Session Manager plugin
          aws --version

          # Get instance ID from tag or direct ID
          INSTANCE_ID="${{ secrets.AWS_INSTANCE_ID }}"

          echo "Instance ID: $INSTANCE_ID"

      - name: Deploy to main server
        env:
          INSTANCE_ID: ${{ secrets.AWS_INSTANCE_ID }}
        run: |
          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "set -e",
              "PROJECT_DIR=\"/home/Blockchain-based-IoT-Server\"",
              "PROJECT_NAME=\"main\"",
              "echo \"ðŸ“¦ Pulling latest changes...\"",
              "cd $PROJECT_DIR",
              "git fetch origin main",
              "git reset --hard origin/main",
              "echo \"ðŸ”§ Stopping existing containers...\"",
              "sudo docker compose -p $PROJECT_NAME down --remove-orphans",
              "echo \"ðŸ—ï¸ Building Docker images...\"",
              "sudo docker compose -p $PROJECT_NAME build --no-cache",
              "echo \"ðŸš€ Starting containers...\"",
              "sudo  docker compose -p $PROJECT_NAME up -d",
              "echo \"â³ Waiting for services to be healthy...\"",
              "sleep 10",
              "echo \"ðŸ“Š Container status:\"",
              "sudo  docker compose -p $PROJECT_NAME ps",
              "echo \"ðŸ§¹ Cleaning up unused Docker resources...\"",
              "sudo  docker image prune -af --filter \"until=24h\"",
              "sudo  docker volume prune -f --filter \"label!=keep\"",
              "echo \"âœ… Deployment completed successfully!\""
            ]' \
            --output text \
            --query "Command.CommandId" > command_id.txt

          COMMAND_ID=$(cat command_id.txt)
          echo "Command ID: $COMMAND_ID"

          # Wait for command to complete
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "$INSTANCE_ID" \
              --query "Status" \
              --output text)
            
            echo "Status: $STATUS"
            
            if [ "$STATUS" = "Success" ]; then
              echo "âœ… Command completed successfully"
              break
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "âŒ Command failed with status: $STATUS"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "$INSTANCE_ID"
              exit 1
            fi
            
            sleep 5
          done

      - name: Verify deployment
        env:
          INSTANCE_ID: ${{ secrets.AWS_INSTANCE_ID }}
        run: |
          aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "PROJECT_NAME=\"main\"",
              "RUNNING=$(sudo docker compose -p $PROJECT_NAME ps --status running --quiet | wc -l)",
              "TOTAL=$(sudo  docker compose -p $PROJECT_NAME ps --quiet | wc -l)",
              "echo \"Containers running: $RUNNING/$TOTAL\"",
              "if [ \"$RUNNING\" -ne \"$TOTAL\" ]; then",
              "  echo \"âŒ Not all containers are running!\"",
              "  sudo  docker compose -p $PROJECT_NAME logs --tail=50",
              "  exit 1",
              "fi",
              "echo \"âœ… All containers are running\""
            ]' \
            --output text \
            --query "Command.CommandId" > verify_command_id.txt

          COMMAND_ID=$(cat verify_command_id.txt)

          # Wait for verification
          sleep 10
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID"
