name: Deploy to Production
permissions:
  contents: read

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://github.com/TheArchitect2000/Blockchain-based-IoT-Server/
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}" > ~/.ssh/production_key
          chmod 600 ~/.ssh/production_key
          ssh-keyscan -H ${{ secrets.PRODUCTION_SERVER }} >> ~/.ssh/known_hosts

      - name: Deploy to production server
        env:
          HOSTNAME: ${{ secrets.PRODUCTION_SERVER }}
          USERNAME: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh -i ~/.ssh/production_key ${USERNAME}@${HOSTNAME} << 'EOF'
            set -e
            
            PROJECT_DIR="/home/Blockchain-based-IoT-Server"
            PROJECT_NAME="production"
            
            echo "ðŸ“¦ Pulling latest changes..."
            cd $PROJECT_DIR
            git fetch origin main
            git reset --hard origin/main
            
            echo "ðŸ’¾ Creating backup..."
            BACKUP_DIR="/home/backups/$(date +%Y%m%d_%H%M%S)"
            mkdir -p $BACKUP_DIR
            docker compose -p $PROJECT_NAME ps -q | xargs -I {} docker commit {} $BACKUP_DIR/container_{}
            
            echo "ðŸ”§ Stopping existing containers..."
            docker compose -p $PROJECT_NAME down --remove-orphans
            
            echo "ðŸ—ï¸ Building Docker images..."
            docker compose -p $PROJECT_NAME build --no-cache
            
            echo "ðŸš€ Starting containers..."
            docker compose -p $PROJECT_NAME up -d
            
            echo "â³ Waiting for services to be healthy..."
            sleep 15
            
            echo "ðŸ“Š Container status:"
            docker compose -p $PROJECT_NAME ps
            
            echo "ðŸ§¹ Cleaning up unused Docker resources..."
            docker image prune -af --filter "until=48h"
            docker volume prune -f --filter "label!=keep"
            
            echo "ðŸ—‚ï¸ Cleaning old backups (keeping last 5)..."
            ls -t /home/backups/ | tail -n +6 | xargs -I {} rm -rf /home/backups/{}
            
            echo "âœ… Deployment completed successfully!"
          EOF

      - name: Verify deployment
        env:
          HOSTNAME: ${{ secrets.PRODUCTION_SERVER }}
          USERNAME: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh -i ~/.ssh/production_key ${USERNAME}@${HOSTNAME} << 'EOF'
            PROJECT_NAME="production"
            
            # Check if all containers are running
            RUNNING=$(docker compose -p $PROJECT_NAME ps --status running --quiet | wc -l)
            TOTAL=$(docker compose -p $PROJECT_NAME ps --quiet | wc -l)
            
            echo "Containers running: $RUNNING/$TOTAL"
            
            if [ "$RUNNING" -ne "$TOTAL" ]; then
              echo "âŒ Not all containers are running!"
              docker compose -p $PROJECT_NAME logs --tail=100
              exit 1
            fi
            
          EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/production_key
